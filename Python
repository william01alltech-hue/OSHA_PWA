import pandas as pd
import json
import os

# ---------------------------------------------------------------------------
# è·å®‰è¡›å­¸ç§‘é¡Œåº«è½‰æª”å·¥å…· (é™„å¸¶çµ‚ç«¯æ©Ÿå¼·åŠ›é™¤éŒ¯é›·é”)
# ---------------------------------------------------------------------------

EXCEL_FILE = 'osha_questions.xlsx'
JS_FILE = 'questions.js'

def map_answer(ans):
    """å°‡æ•¸å­—ç­”æ¡ˆè½‰æ›ç‚ºå­—æ¯"""
    ans = str(ans).strip().split('.')[0]
    mapping = {'1': 'A', '2': 'B', '3': 'C', '4': 'D'}
    return mapping.get(ans, ans)

def determine_level(subject_str):
    subject_str = str(subject_str)
    if 'ç”²ç´šå®‰å…¨' in subject_str: return 'ç”²ç´šå®‰å…¨'
    if 'ç”²ç´šè¡›ç”Ÿ' in subject_str: return 'ç”²ç´šè¡›ç”Ÿ'
    if 'ä¹™ç´š' in subject_str: return 'ä¹™ç´šè·å®‰è¡›'
    return 'å…¶ä»–'

def main():
    print(f"å•Ÿå‹•é¡Œåº«è½‰æª”å¼•æ“ (é™¤éŒ¯ç‰ˆ)ï¼šæº–å‚™è®€å– {EXCEL_FILE}...\n")
    
    question_bank = {"exam": [], "law": []}
    
    try:
        xls = pd.ExcelFile(EXCEL_FILE)
        
        # --- 1. è™•ç† Exam ---
        if 'Exam' in xls.sheet_names:
            df_exam = pd.read_excel(xls, 'Exam').fillna("") 
            for index, row in df_exam.iterrows():
                if str(row.get('é¡Œç›®å…§å®¹', '')).strip() == '': continue
                year = str(row.get('å¹´åº¦', '')).split('.')[0]
                batch = str(row.get('æ¢¯æ¬¡', '')).split('.')[0]
                combined_batch = f"{year}-{batch}" if year and batch else ""
                
                question_bank["exam"].append({
                    "level": determine_level(row.get('ç§‘ç›®', '')),
                    "batch": combined_batch,
                    "type": str(row.get('æ¨¡å¼', '')).strip(),
                    "qNum": str(index + 1), 
                    "question": str(row.get('é¡Œç›®å…§å®¹', '')).strip(),
                    "options": [
                        str(row.get('é¸é …1', '')).strip(), str(row.get('é¸é …2', '')).strip(),
                        str(row.get('é¸é …3', '')).strip(), str(row.get('é¸é …4', '')).strip()
                    ],
                    "answer": map_answer(row.get('æ­£ç¢ºç­”æ¡ˆ', ''))
                })
            print(f"âœ… [Exam] å·²åŒ¯å…¥ {len(question_bank['exam'])} ç­†æ­·å±†è©¦é¡Œã€‚")
        
        # --- 2. è™•ç† Law (åŠ ä¸Šå¼·åŠ›é™¤éŒ¯) ---
        if 'Law' in xls.sheet_names:
            print("\nğŸ” æ­£åœ¨åµæ¸¬ Law åˆ†é çš„çœŸå¯¦çµæ§‹...")
            df_law = pd.read_excel(xls, 'Law').fillna("")
            
            # å°å‡ºæ‰€æœ‰æ¬„ä½åç¨±è®“æ‚¨ç¢ºèª
            columns = df_law.columns.tolist()
            print(f"   â¤ Law åˆ†é å…±æœ‰ {len(columns)} å€‹æ¬„ä½ã€‚")
            print(f"   â¤ æ¬„ä½æ¸…å–®ï¼š{columns}")
            
            # é–å®šç¬¬ O æ¬„ (ç´¢å¼•å€¼ç‚º 14)
            category_col = None
            if len(columns) > 14:
                category_col = columns[14]
                print(f"   â¤ æˆåŠŸé–å®šç¬¬ O æ¬„ï¼Œæ¬„ä½åç¨±ç‚ºï¼šã€{category_col}ã€‘")
            else:
                print(f"   âŒ [åš´é‡è­¦å‘Š] Law åˆ†é æ²’æœ‰ç¬¬ O æ¬„ï¼æœ€å¾Œä¸€å€‹æ¬„ä½æ˜¯ï¼šã€{columns[-1]}ã€‘")

            for index, row in df_law.iterrows():
                if str(row.get('é¡Œç›®å…§å®¹', '')).strip() == '': continue
                
                # æŠ“å–åˆ†é¡åç¨±
                category_name = ""
                if category_col:
                    category_name = str(row[category_col]).strip()
                    
                if not category_name or category_name.lower() == 'nan':
                    category_name = 'å…¶ä»–'
                    
                question_bank["law"].append({
                    "category": category_name,
                    "type": str(row.get('æ¨¡å¼', '')).strip(),
                    "qNum": str(index + 1),
                    "question": str(row.get('é¡Œç›®å…§å®¹', '')).strip(),
                    "options": [
                        str(row.get('é¸é …1', '')).strip(), str(row.get('é¸é …2', '')).strip(),
                        str(row.get('é¸é …3', '')).strip(), str(row.get('é¸é …4', '')).strip()
                    ],
                    "answer": map_answer(row.get('æ­£ç¢ºç­”æ¡ˆ', ''))
                })
            print(f"\nâœ… [Law] å·²åŒ¯å…¥ {len(question_bank['law'])} ç­†åˆ†é¡æ³•è¦è©¦é¡Œã€‚")
        
        # --- 3. åŒ¯å‡º JS ---
        json_str = json.dumps(question_bank, ensure_ascii=False, indent=4)
        with open(JS_FILE, 'w', encoding='utf-8') as f:
            f.write(f"// æœ¬æª”æ¡ˆç”± convert.py è‡ªå‹•ç”Ÿæˆ\nconst questionBank = {json_str};\n")
            
        print(f"\nğŸ‰ è½‰æª”å®Œç•¢ï¼è«‹æŸ¥çœ‹ä¸Šæ–¹é™¤éŒ¯è¨Šæ¯ã€‚")

    except Exception as e:
        print(f"âŒ [éŒ¯èª¤] ä¾‹å¤–ç™¼ç”Ÿï¼š{e}")

if __name__ == "__main__":
    main()