<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>甲級職安衛系統 - V6 自動偵測版</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { --primary-color: #003366; --accent-color: #ff9800; }
        body { background-color: #f4f7f9; font-family: "Microsoft JhengHei", sans-serif; }
        .quiz-header { background: var(--primary-color); color: white; padding: 25px 0; border-bottom: 5px solid var(--accent-color); }
        .card { border-radius: 15px; border: none; box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
        .range-section { background: #e3f2fd; border-radius: 10px; padding: 20px; border: 2px solid #90caf9; margin-bottom: 20px; display: none; }
        .option-btn { text-align: left; margin-bottom: 12px; width: 100%; border-radius: 10px; border: 1px solid #ddd; padding: 15px; background: white; font-size: 1.1rem; transition: 0.3s; }
        .option-btn:hover:not([disabled]) { border-color: var(--primary-color); background: #f0f7ff; transform: translateY(-2px); }
        .correct { background: #2e7d32 !important; color: white !important; }
        .wrong { background: #c62828 !important; color: white !important; }
        .history-card { background: white; border-radius: 10px; padding: 15px; margin-bottom: 10px; border-left: 5px solid var(--primary-color); }
    </style>
</head>
<body>

    <div class="quiz-header text-center">
        <h1 class="fw-bold">甲級職安衛練習系統 <small class="fs-6 text-warning">自動化引擎 V6</small></h1>
        <div id="user-display" class="fw-bold">尚未登入</div>
    </div>

    <div id="auth-container" class="container mt-5">
        <div class="card p-4 mx-auto shadow-lg" style="max-width: 400px;">
            <h3 class="text-center mb-4">學員登入</h3>
            <div class="mb-3">
                <input type="text" id="username" class="form-control form-control-lg" placeholder="帳號名稱">
            </div>
            <div class="mb-4">
                <input type="password" id="password" class="form-control form-control-lg" placeholder="密碼">
            </div>
            <button onclick="handleAuth()" class="btn btn-primary w-100 btn-lg shadow">進入系統</button>
        </div>
    </div>

    <div id="setup-container" class="container mt-4" style="display:none;">
        <div class="row">
            <div class="col-md-7 mb-4">
                <div class="card p-4 h-100 shadow">
                    <h4 class="fw-bold text-primary mb-4 border-bottom pb-2">測驗參數設定</h4>
                    
                    <div class="mb-4">
                        <label class="form-label fw-bold fs-5">第一步：選擇測驗類型</label>
                        <select id="type-select" class="form-select form-select-lg" onchange="toggleUI()">
                            <option value="single">學科測試 (單選題)</option>
                            <option value="multiple">學科測試 (複選題)</option>
                            <option value="full-80">學科全測 (單/複選題) 80 題</option>
                            <option value="essay">術科測試 (問答題)</option>
                        </select>
                    </div>

                    <div class="row mb-4">
                        <div class="col">
                            <label class="form-label fw-bold">年度</label>
                            <select id="year-select" class="form-select form-select-lg"></select>
                        </div>
                        <div class="col">
                            <label class="form-label fw-bold">梯次</label>
                            <select id="batch-select" class="form-select form-select-lg"></select>
                        </div>
                    </div>

                    <div id="range-section" class="range-section">
                        <label class="form-label fw-bold text-primary fs-5">第二步：選擇練習題號範圍</label>
                        <select id="range-select" class="form-select form-select-lg border-primary">
                            <option value="1-30">1. 第 1 - 30 題</option>
                            <option value="31-60">2. 第 31 - 60 題</option>
                            <option value="1-60">3. 第 1 - 60 題</option>
                        </select>
                    </div>

                    <div class="form-check form-switch mb-4">
                        <input class="form-check-input" type="checkbox" id="random-switch" checked>
                        <label class="form-check-label fw-bold">隨機打亂題目順序</label>
                    </div>

                    <button onclick="prepareQuiz('normal')" class="btn btn-primary w-100 btn-lg shadow mb-3">開始測驗</button>
                    <button onclick="prepareQuiz('wrong')" class="btn btn-danger w-100 shadow-sm" id="wrong-btn">錯題強化重考 (0 題)</button>
                </div>
            </div>

            <div class="col-md-5 mb-4">
                <div class="card p-4 h-100 shadow">
                    <h4 class="fw-bold mb-4 border-bottom pb-2">個人最近成績</h4>
                    <div id="history-list" class="overflow-auto" style="max-height: 450px;"></div>
                    <button onclick="location.reload()" class="btn btn-link btn-sm text-danger mt-3">切換帳號 / 登出</button>
                </div>
            </div>
        </div>
    </div>

    <div id="quiz-container" class="container mt-3" style="display:none;">
        <div class="sticky-top bg-white p-3 mb-4 border-bottom d-flex justify-content-between align-items-center shadow-sm rounded">
            <button onclick="exitQuiz()" class="btn btn-outline-secondary">結束退出</button>
            <span id="quiz-title" class="fw-bold text-primary fs-4"></span>
            <div id="score-counter" class="badge bg-dark fs-6"></div>
        </div>
        <div id="question-list"></div>
        <div class="text-center mt-5 mb-5">
            <button onclick="submitQuiz()" class="btn btn-success btn-lg px-5 shadow-lg fw-bold">完成測驗並結算分數</button>
        </div>
    </div>

    <script src="questions.js"></script>
    <script>
        let currentUser = null;
        let currentQuizQuestions = [];
        let userAnswers = {};

        // --- 自動偵測與填入選單功能 ---
        function autoPopulateMenus() {
            if (typeof questionBank === 'undefined') return;

            // 抓取所有不重複的年度與梯次，並由大到小排序
            const years = [...new Set(questionBank.map(q => q.year))].sort((a, b) => b - a);
            const batches = [...new Set(questionBank.map(q => q.batch))].sort((a, b) => a - b);

            const yearSelect = document.getElementById('year-select');
            const batchSelect = document.getElementById('batch-select');

            yearSelect.innerHTML = years.map(y => `<option value="${y}">${y} 年</option>`).join('');
            batchSelect.innerHTML = batches.map(b => `<option value="${b}">第 ${b} 梯次</option>`).join('');
        }

        function toggleUI() {
            const mode = document.getElementById('type-select').value;
            const rangeBox = document.getElementById('range-section');
            rangeBox.style.display = (mode === 'single' || mode === 'multiple') ? 'block' : 'none';
        }

        function handleAuth() {
            const user = document.getElementById('username').value.trim();
            const pass = document.getElementById('password').value.trim();
            if (!user || !pass) return alert("請輸入完整帳密");
            
            let userData = JSON.parse(localStorage.getItem('user_' + user));
            if (userData && userData.password !== pass) return alert("密碼錯誤");
            if (!userData) {
                userData = { password: pass, history: [], wrongBank: [] };
                localStorage.setItem('user_' + user, JSON.stringify(userData));
            }
            currentUser = user;
            document.getElementById('auth-container').style.display = 'none';
            document.getElementById('setup-container').style.display = 'block';
            document.getElementById('user-display').innerText = `目前學員：${currentUser}`;
            
            autoPopulateMenus(); // 登入後執行自動偵測
            toggleUI();
            refreshHistory();
        }

        // --- 以下維持核心邏輯 ---
        function refreshHistory() {
            const data = JSON.parse(localStorage.getItem('user_' + currentUser));
            const list = document.getElementById('history-list');
            list.innerHTML = data.history.reverse().slice(0, 10).map(h => `
                <div class="history-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="fw-bold fs-5 text-primary">${h.score} 分</span>
                        <span class="text-muted small">${h.date.split(' ')[0]}</span>
                    </div>
                    <div class="text-secondary small mt-1">${h.modeText}</div>
                </div>
            `).join('') || '<div class="text-center text-muted py-5">目前尚無練習紀錄</div>';
            document.getElementById('wrong-btn').innerText = `錯題強化重考 (${data.wrongBank.length} 題)`;
        }

        function prepareQuiz(mode) {
            const data = JSON.parse(localStorage.getItem('user_' + currentUser));
            const modeVal = document.getElementById('type-select').value;
            const year = parseInt(document.getElementById('year-select').value);
            const batch = parseInt(document.getElementById('batch-select').value);
            const range = document.getElementById('range-select').value;

            let filtered = [];

            if (mode === 'wrong') {
                filtered = questionBank.filter(q => data.wrongBank.includes(q.id));
            } else if (modeVal === 'full-80') {
                const s = questionBank.filter(q => parseInt(q.year)===year && parseInt(q.batch)===batch && String(q.mode).trim()==='單選').sort((a,b)=>String(a.id).localeCompare(String(b.id))).slice(0, 60);
                const m = questionBank.filter(q => parseInt(q.year)===year && parseInt(q.batch)===batch && String(q.mode).trim()==='複選').sort((a,b)=>String(a.id).localeCompare(String(b.id))).slice(0, 20);
                filtered = [...s, ...m];
            } else {
                filtered = questionBank.filter(q => {
                    const basic = parseInt(q.year) === year && parseInt(q.batch) === batch;
                    if (modeVal === 'essay') return basic && q.type === 'essay';
                    if (modeVal === 'single') return basic && String(q.mode).trim() === '單選';
                    if (modeVal === 'multiple') return basic && String(q.mode).trim() === '複選';
                    return false;
                }).sort((a,b) => String(a.id).localeCompare(String(b.id)));

                if (modeVal === 'single' || modeVal === 'multiple') {
                    if (range === '1-30') filtered = filtered.slice(0, 30);
                    else if (range === '31-60') filtered = filtered.slice(30, 60);
                    else if (range === '1-60') filtered = filtered.slice(0, 60);
                }
            }

            if (filtered.length === 0) return alert("⚠ 找不到題目！請確認 Excel 是否有填寫該年度與梯次的資料。");
            if (document.getElementById('random-switch').checked) filtered.sort(() => Math.random() - 0.5);

            currentQuizQuestions = filtered;
            userAnswers = {};
            document.getElementById('setup-container').style.display = 'none';
            document.getElementById('quiz-container').style.display = 'block';
            document.getElementById('quiz-title').innerText = document.getElementById('type-select').selectedOptions[0].text;
            render();
        }

        function render() {
            const list = document.getElementById('question-list');
            list.innerHTML = '';
            currentQuizQuestions.forEach((q, i) => {
                const card = document.createElement('div');
                card.className = 'card p-4 mb-4 shadow-sm';
                let html = `<h5 class="mb-4 text-dark border-bottom pb-2">第 ${i+1} 題 [${q.mode || '問答'}]：${q.question}</h5>`;
                
                if (q.type === 'choice') {
                    if (q.mode === '單選') {
                        q.options.forEach((opt, oi) => html += `<button class="option-btn opt-${i}" onclick="checkS(${i},'${oi+1}','${q.answer}',this)">${opt}</button>`);
                    } else {
                        html += `<div class="p-3 bg-light rounded border">`;
                        q.options.forEach((opt, oi) => html += `<div class="form-check fs-5 mb-2"><input class="form-check-input ck-${i}" type="checkbox" value="${oi+1}" id="q${i}o${oi}"><label class="form-check-label" for="q${i}o${oi}">${opt}</label></div>`);
                        html += `<button class="btn btn-primary btn-sm mt-3 px-4" onclick="checkM(${i},'${q.answer}')">提交本題答案</button></div>`;
                    }
                } else {
                    html += `<button class="btn btn-info mt-2 px-4 fw-bold" onclick="this.nextSibling.style.display='block'; userAnswers[${i}]=true;">顯示參考解答</button><div class="p-4 bg-light mt-3 border rounded" style="display:none; white-space: pre-wrap; line-height: 1.8;">${q.answer}</div>`;
                }
                html += `<div id="fb-${i}" class="mt-3 fs-5 fw-bold"></div>`;
                card.innerHTML = html;
                list.appendChild(card);
            });
            window.scrollTo(0,0);
        }

        function checkS(idx, p, c, btn) {
            document.querySelectorAll(`.opt-${idx}`).forEach(b => b.disabled = true);
            const isC = (String(p) === String(c));
            userAnswers[idx] = isC;
            if (isC) btn.classList.add('correct');
            else { btn.classList.add('wrong'); const btns = document.querySelectorAll(`.opt-${idx}`); if(btns[parseInt(c)-1]) btns[parseInt(c)-1].classList.add('correct'); }
        }

        function checkM(idx, c) {
            const cks = document.querySelectorAll(`.ck-${idx}`);
            let p = Array.from(cks).filter(ck => ck.checked).map(ck => ck.value).sort().join('');
            let a = String(c).split('').sort().join('');
            cks.forEach(ck => ck.disabled = true);
            userAnswers[idx] = (p === a);
            document.getElementById(`fb-${idx}`).innerHTML = userAnswers[idx] ? `<span class="text-success">✅ 正確</span>` : `<span class="text-danger">❌ 錯誤 (正解：${a})</span>`;
        }

        function submitQuiz() {
            const correctNum = Object.values(userAnswers).filter(v => v === true).length;
            const score = Math.round((correctNum / currentQuizQuestions.length) * 100);
            let data = JSON.parse(localStorage.getItem('user_' + currentUser));
            data.history.push({ score, modeText: document.getElementById('quiz-title').innerText, date: new Date().toLocaleString() });
            currentQuizQuestions.forEach((q, i) => {
                if (userAnswers[i] === false) { if (!data.wrongBank.includes(q.id)) data.wrongBank.push(q.id); }
                else if (userAnswers[i] === true) data.wrongBank = data.wrongBank.filter(id => id !== q.id);
            });
            localStorage.setItem('user_' + currentUser, JSON.stringify(data));
            alert(`測驗結束！總得分：${score} 分`);
            location.reload();
        }

        function exitQuiz() { if(confirm("確定結束？")) location.reload(); }
    </script>
</body>
</html>