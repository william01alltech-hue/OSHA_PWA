<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è·å®‰è¡›ç³»çµ± - V29 æ¨¡å‹æƒæç‰ˆ</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="logo.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
        window.onerror = function(msg, url, line) {
            if (msg.includes("Script error")) return;
            if (msg.includes("API_KEY") || msg.includes("SyntaxError")) {
                alert(`â›” åš´é‡éŒ¯èª¤ï¼API Key è²¼éŒ¯ä½ç½®ã€‚\néŒ¯èª¤ï¼š${msg}\nè¡Œæ•¸ï¼š${line}`);
            }
            return false;
        };
    </script>

    <style>
        :root { --primary-color: #003366; --accent-color: #ff9800; }
        body { background-color: #f4f7f9; font-family: "Microsoft JhengHei", sans-serif; -webkit-tap-highlight-color: transparent; }
        .quiz-header { background: var(--primary-color); color: white; padding: 20px 0; border-bottom: 5px solid var(--accent-color); }
        .card { border-radius: 15px; border: none; box-shadow: 0 8px 20px rgba(0,0,0,0.15); margin-bottom: 20px; }
        .option-btn { text-align: left; margin-bottom: 12px; width: 100%; border-radius: 12px; border: 1px solid #ddd; padding: 15px; background: white; font-size: 1.1rem; cursor: pointer; display: block; }
        .option-btn:hover:not([disabled]) { border-color: var(--primary-color); background: #f0f7ff; }
        .correct { background: #2e7d32 !important; color: white !important; }
        .wrong { background: #c62828 !important; color: white !important; }
        .essay-input { width: 100%; min-height: 150px; border-radius: 10px; border: 2px solid #ddd; padding: 12px; font-size: 1.1rem; margin-top: 10px; }
        .ai-feedback-box { background: #e3f2fd; border-left: 5px solid #2196f3; padding: 15px; margin-top: 15px; border-radius: 5px; }
        .ref-answer-box { background: #f1f8e9; border-left: 5px solid #558b2f; padding: 15px; margin-top: 10px; border-radius: 5px; color: #33691e; }
        .criteria-box { background: #fff3e0; border-left: 5px solid #ff9800; padding: 10px; margin-top: 10px; color: #e65100; }
        .mic-btn { font-size: 1.8rem; border: none; background: #f8d7da; color: #dc3545; border-radius: 50%; width: 55px; height: 55px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .ai-loading { display: inline-block; width: 1rem; height: 1rem; border: 2px solid currentColor; border-right-color: transparent; border-radius: 50%; animation: spinner-border .75s linear infinite; }
        @keyframes spinner-border { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="quiz-header text-center">
        <h1 class="fw-bold">è·å®‰è¡›ç³»çµ± <small class="fs-6 text-warning">V29</small></h1>
        <div id="user-display" class="fw-bold">ç³»çµ±åˆå§‹åŒ–...</div>
    </div>

    <div id="auth-container" class="container mt-4">
        <div class="card p-4 mx-auto shadow-lg" style="max-width: 400px;">
            <h3 class="text-center mb-4 text-primary">å­¸å“¡ç™»å…¥</h3>
            <input type="text" id="username" class="form-control mb-3" placeholder="å¸³è™Ÿ">
            <input type="password" id="password" class="form-control mb-4" placeholder="å¯†ç¢¼">
            <button onclick="handleAuth()" class="btn btn-primary w-100 btn-lg shadow">é€²å…¥ç³»çµ±</button>
        </div>
    </div>

    <div id="setup-container" class="container mt-4" style="display:none;">
        <div class="row">
            <div class="col-md-7">
                <div class="card p-4 shadow">
                    <h4 class="fw-bold text-primary mb-4">æ¸¬é©—è¨­å®š</h4>
                    
                    <div class="mb-4 bg-light p-3 rounded border border-primary">
                        <label class="fw-bold text-primary mb-2">ğŸ¤– AI æ¨¡å‹è¨­å®š</label>
                        <div class="input-group mb-2">
                            <button class="btn btn-primary" type="button" onclick="scanAvailableModels()">ğŸ” æƒæå¯ç”¨æ¨¡å‹</button>
                            <select id="model-select" class="form-select">
                                <option value="" disabled selected>è«‹å…ˆé»æ“Šæƒæ...</option>
                            </select>
                        </div>
                        <div id="scan-status" class="form-text text-danger fw-bold"></div>
                    </div>

                    <div class="mb-4">
                        <label class="fw-bold fs-5">ç¬¬ä¸€æ­¥ï¼šæ¸¬é©—é¡å‹</label>
                        <select id="type-select" class="form-select form-select-lg" onchange="toggleUI()">
                            <option value="essay">è¡“ç§‘æ¸¬è©¦ (AI é–±å·)</option>
                            <option value="single">å­¸ç§‘æ¸¬è©¦ (å–®é¸)</option>
                            <option value="multiple">å­¸ç§‘æ¸¬è©¦ (è¤‡é¸)</option>
                            <option value="full-80">å…¨æ¸¬ (80é¡Œ)</option>
                        </select>
                    </div>
                    <div class="row mb-4">
                        <div class="col"><label class="fw-bold">å¹´åº¦</label><select id="year-select" class="form-select"></select></div>
                        <div class="col"><label class="fw-bold">æ¢¯æ¬¡</label><select id="batch-select" class="form-select"></select></div>
                    </div>
                    <div id="range-section" style="display:none;" class="mb-4">
                        <label class="fw-bold">ç¯„åœ</label>
                        <select id="range-select" class="form-select"><option value="1-60">1-60é¡Œ</option></select>
                    </div>
                    <button onclick="prepareQuiz('normal')" class="btn btn-primary w-100 btn-lg shadow mb-3">é–‹å§‹æ¸¬é©—</button>
                    <button onclick="prepareQuiz('wrong')" class="btn btn-danger w-100 shadow-sm" id="wrong-btn">éŒ¯é¡Œå¼·åŒ– (0 é¡Œ)</button>
                </div>
            </div>
            <div class="col-md-5">
                <div class="card p-4 shadow">
                    <h4 class="fw-bold mb-4">ç´€éŒ„</h4>
                    <div id="history-list" class="overflow-auto" style="max-height: 400px;"></div>
                    <button onclick="logout()" class="btn btn-link w-100 mt-3 text-danger">ç™»å‡º</button>
                </div>
            </div>
        </div>
    </div>

    <div id="quiz-container" class="container mt-3" style="display:none;">
        <div class="sticky-top bg-white p-3 mb-4 border-bottom shadow-sm d-flex justify-content-between align-items-center">
            <button id="exit-btn" onclick="exitQuiz()" class="btn btn-outline-secondary btn-sm">é€€å‡º</button>
            <span id="quiz-title" class="fw-bold text-primary"></span>
            <div id="quiz-status" class="badge bg-dark">ä½œç­”ä¸­</div>
        </div>
        <div id="question-list"></div>
        <div id="submit-area" class="text-center mt-5 mb-5">
            <button id="ai-submit-btn" onclick="submitQuizWithAI()" class="btn btn-success btn-lg px-5 shadow fw-bold">äº¤å·ä¸¦å‘¼å« AI</button>
            <div id="ai-loading-msg" class="text-primary mt-3 fw-bold" style="display:none;">
                <span class="ai-loading me-2"></span>AI è€å¸«é–±å·ä¸­...
            </div>
        </div>
        <div id="finish-area" class="text-center mt-5 mb-5" style="display:none;">
            <button onclick="location.reload()" class="btn btn-primary btn-lg px-5 shadow fw-bold">è¿”å›</button>
        </div>
    </div>

    <script src="questions.js"></script>
    <script>
        // ==========================================
        // â˜… å¿…å¡«ï¼šè«‹å°‡æ‚¨çš„ API Key è²¼åœ¨ä¸‹æ–¹å¼•è™Ÿä¸­
        // ==========================================
        const SYSTEM_API_KEY = "AIzaSyBVNhf-jPE1G-GD8q8FtbjnlK-_5StKL-I"; 

        let currentUser = null, currentQuizQuestions = [], userAnswers = {}, aiResults = {}, isReviewMode = false;
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = SpeechRecognition ? new SpeechRecognition() : null;
        if(recognition) { recognition.lang='zh-TW'; recognition.continuous=false; }

        window.onload = function() {
            const u = localStorage.getItem('active_session_user');
            if(u) { currentUser=u; showDashboard(); } else { document.getElementById('user-display').innerText="æœªç™»å…¥"; }
        };

        function autoPopulateMenus() {
            if(typeof questionBank === 'undefined') return;
            const years = [...new Set(questionBank.map(q=>q.year))].sort((a,b)=>b-a);
            document.getElementById('year-select').innerHTML = years.map(y=>`<option value="${y}">${y} å¹´</option>`).join('');
            const batches = [...new Set(questionBank.map(q=>q.batch))].sort((a,b)=>a-b);
            document.getElementById('batch-select').innerHTML = batches.map(b=>`<option value="${b}">ç¬¬ ${b} æ¢¯æ¬¡</option>`).join('');
        }

        function toggleUI() {
            const m = document.getElementById('type-select').value;
            const r = document.getElementById('range-section');
            if(r) r.style.display = (m==='single'||m==='multiple') ? 'block' : 'none';
        }

        function handleAuth() {
            const u = document.getElementById('username').value.trim();
            const p = document.getElementById('password').value.trim();
            if(!u||!p) return alert("è«‹è¼¸å…¥å¸³å¯†");
            let d = JSON.parse(localStorage.getItem('user_'+u))||{password:p, history:[], wrongBank:[]};
            if(d.password!==p) return alert("å¯†ç¢¼éŒ¯èª¤");
            currentUser=u;
            localStorage.setItem('user_'+u, JSON.stringify(d));
            localStorage.setItem('active_session_user', currentUser);
            showDashboard();
        }

        function showDashboard() {
            document.getElementById('auth-container').style.display='none';
            document.getElementById('setup-container').style.display='block';
            document.getElementById('user-display').innerText = `å­¸å“¡ï¼š${currentUser}`;
            autoPopulateMenus(); toggleUI();
            const d = JSON.parse(localStorage.getItem('user_'+currentUser));
            document.getElementById('history-list').innerHTML = d.history.reverse().slice(0,10).map(h=>`<div><b>${h.score}åˆ†</b> <small>${h.modeText}</small></div>`).join('')||'ç„¡ç´€éŒ„';
            document.getElementById('wrong-btn').innerText=`éŒ¯é¡Œ (${d.wrongBank.length})`;
        }

        function logout() { localStorage.removeItem('active_session_user'); location.reload(); }

        function prepareQuiz(mode) {
            // æª¢æŸ¥æ˜¯å¦å·²é¸æ“‡æ¨¡å‹
            const model = document.getElementById('model-select').value;
            const type = document.getElementById('type-select').value;
            if(type === 'essay' && (!model || model === '')) {
                alert("âš ï¸ è«‹å…ˆé»æ“Šã€ŒğŸ” æƒæå¯ç”¨æ¨¡å‹ã€ä¸¦é¸æ“‡ä¸€å€‹æ¨¡å‹ï¼");
                return;
            }

            const d = JSON.parse(localStorage.getItem('user_'+currentUser));
            const y = document.getElementById('year-select').value;
            const b = document.getElementById('batch-select').value;
            
            if(mode==='wrong') {
                currentQuizQuestions = questionBank.filter(q=>d.wrongBank.includes(q.id));
            } else if(type==='full-80') {
                const s = questionBank.filter(q=>q.year==y&&q.batch==b&&q.mode=='å–®é¸').slice(0,60);
                const m = questionBank.filter(q=>q.year==y&&q.batch==b&&q.mode=='è¤‡é¸').slice(0,20);
                currentQuizQuestions = [...s, ...m];
            } else {
                currentQuizQuestions = questionBank.filter(q => {
                    const basic = q.year==y && q.batch==b;
                    if(type==='essay') return basic && q.type==='essay';
                    if(type==='single') return basic && q.mode==='å–®é¸';
                    if(type==='multiple') return basic && q.mode==='è¤‡é¸';
                    return false;
                });
                if(type==='single'||type==='multiple') {
                    const range = document.getElementById('range-select').value;
                    if(range==='1-30') currentQuizQuestions=currentQuizQuestions.slice(0,30);
                    else currentQuizQuestions=currentQuizQuestions.slice(0,60);
                }
            }

            if(currentQuizQuestions.length===0) return alert("ç„¡é¡Œç›®");
            document.getElementById('setup-container').style.display='none';
            document.getElementById('quiz-container').style.display='block';
            
            const sBtn = document.getElementById('ai-submit-btn');
            const fArea = document.getElementById('finish-area');
            const lMsg = document.getElementById('ai-loading-msg');
            if(sBtn) sBtn.style.display='block';
            if(fArea) fArea.style.display='none';
            if(lMsg) lMsg.style.display='none';
            
            document.getElementById('quiz-status').innerText="ä½œç­”ä¸­";
            render();
        }

        function render() {
            const list = document.getElementById('question-list');
            list.innerHTML = '';
            currentQuizQuestions.forEach((q, i) => {
                const card = document.createElement('div');
                card.className = 'card p-4 shadow-sm';
                if(q.type === 'choice') {
                    let h = `<h5 class="mb-3">ç¬¬${i+1}é¡Œï¼š${q.question}</h5>`;
                    q.options.forEach((opt, oi) => {
                        let cls = 'option-btn';
                        if(isReviewMode) {
                            if(oi+1 == q.answer) cls += ' correct';
                            else if(userAnswers[i] == oi+1) cls += ' wrong';
                        }
                        h += `<button class="${cls}" onclick="userAnswers[${i}]=${oi+1}; this.classList.add('bg-primary','text-white')" ${isReviewMode?'disabled':''}>(${oi+1}) ${opt}</button>`;
                    });
                    card.innerHTML = h;
                } else {
                    const aiData = aiResults[i];
                    let h = `<h5 class="mb-3">ç¬¬${i+1}é¡Œï¼š${q.question}</h5>
                        <div class="mb-3"><div class="d-flex justify-content-between mb-2"><b>ä½œç­”å€ ${isReviewMode&&aiData?`<span class="text-danger">(${aiData.score}åˆ†)</span>`:''}</b>${!isReviewMode?`<button class="mic-btn" onclick="startVoice(${i})">ğŸ¤</button>`:''}</div>
                        <textarea id="ans-${i}" class="essay-input" ${isReviewMode?'disabled':''} oninput="userAnswers[${i}]=this.value">${userAnswers[i]||''}</textarea></div>`;
                    if(isReviewMode) {
                        if(aiData) h += `<div class="ai-feedback-box"><b>ğŸ¤– AIï¼š</b>${marked.parse(aiData.feedback)}</div>`;
                        h += `<div class="criteria-box"><b>æ¨™æº–ï¼š</b>${q.criteria_display||'ç„¡'}</div><div class="ref-answer-box"><b>åƒè€ƒè§£ç­”ï¼š</b>${q.answer}</div>`;
                    }
                    card.innerHTML = h;
                }
                list.appendChild(card);
            });
        }

        function startVoice(idx) {
            if(!recognition) return alert("ä¸æ”¯æ´èªéŸ³");
            recognition.start();
            recognition.onresult = e => { 
                const t = e.results[0][0].transcript; 
                document.getElementById(`ans-${idx}`).value += t; 
                userAnswers[idx] = document.getElementById(`ans-${idx}`).value; 
            };
        }

        // --- V29 æ ¸å¿ƒï¼šè‡ªå‹•æƒææ¨¡å‹ ---
        async function scanAvailableModels() {
            const key = SYSTEM_API_KEY.trim();
            const statusDiv = document.getElementById('scan-status');
            const select = document.getElementById('model-select');

            if(key.includes("è«‹åœ¨æ­¤è™•") || key.length < 10) {
                alert("è«‹å…ˆå¡«å…¥æ­£ç¢ºçš„ API Keyï¼");
                return;
            }

            statusDiv.innerText = "â³ æ­£åœ¨é€£æ¥ Google ä¼ºæœå™¨æƒæå¯ç”¨æ¨¡å‹...";
            statusDiv.className = "form-text text-primary fw-bold";
            select.innerHTML = "<option>æƒæä¸­...</option>";

            try {
                // å‘¼å« Google æŸ¥è©¢æ¨¡å‹åˆ—è¡¨
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${key}`);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error?.message || "é€£ç·šå¤±æ•—");
                }

                // éæ¿¾å‡ºå¯ä»¥ç”¨ä¾† "generateContent" çš„æ¨¡å‹
                const validModels = data.models.filter(m => 
                    m.supportedGenerationMethods.includes("generateContent") && 
                    (m.name.includes("gemini") || m.name.includes("chat"))
                );

                if (validModels.length === 0) {
                    throw new Error("æ‚¨çš„å¸³è™Ÿæ¬Šé™ä¸è¶³ï¼Œæ‰¾ä¸åˆ°ä»»ä½•å¯ç”¨æ¨¡å‹ (å¯èƒ½æ˜¯å­¸æ ¡/å…¬å¸å¸³è™Ÿé™åˆ¶)");
                }

                // æ›´æ–°ä¸‹æ‹‰é¸å–®
                select.innerHTML = validModels.map(m => 
                    `<option value="${m.name}">${m.displayName} (${m.name})</option>`
                ).join('');
                
                // è‡ªå‹•é¸ç¬¬ä¸€å€‹
                select.selectedIndex = 0;

                statusDiv.innerText = `âœ… æˆåŠŸï¼æ‰¾åˆ° ${validModels.length} å€‹å¯ç”¨æ¨¡å‹ï¼Œå·²è‡ªå‹•é¸ç”¨æœ€ä½³æ¨¡å‹ã€‚`;
                statusDiv.className = "form-text text-success fw-bold";

            } catch (e) {
                console.error(e);
                statusDiv.innerText = `âŒ æƒæå¤±æ•—ï¼š${e.message}`;
                statusDiv.className = "form-text text-danger fw-bold";
                select.innerHTML = "<option value=''>æƒæå¤±æ•—ï¼Œè«‹æª¢æŸ¥ Key</option>";
                
                // å¦‚æœæ˜¯æ¬Šé™å•é¡Œï¼Œçµ¦äºˆæ›´å¼·çƒˆçš„æç¤º
                if(e.message.includes("403") || e.message.includes("not found")) {
                    alert("âš ï¸ æ‚¨çš„ Key ç„¡æ³•å­˜å–ä»»ä½•æ¨¡å‹ï¼\n\næ¥µå¤§æ©Ÿç‡æ˜¯ã€Œå­¸æ ¡ã€æˆ–ã€Œå…¬å¸ã€Google å¸³è™Ÿé–ä½äº† AI åŠŸèƒ½ã€‚\n\nè«‹å‹™å¿…æ”¹ç”¨å€‹äººçš„ @gmail.com å¸³è™Ÿé‡æ–°ç”³è«‹ Keyã€‚");
                }
            }
        }

        async function submitQuizWithAI() {
            const key = SYSTEM_API_KEY.trim();
            const modelName = document.getElementById('model-select').value;
            
            if(!modelName || modelName.includes("æƒæ")) {
                alert("è«‹å…ˆå›åˆ°è¨­å®šé é¢ï¼Œé»æ“Šã€Œæƒæå¯ç”¨æ¨¡å‹ã€ï¼");
                return;
            }

            if(!confirm("ç¢ºå®šäº¤å·ï¼Ÿ")) return;

            document.getElementById('ai-submit-btn').style.display='none';
            document.getElementById('ai-loading-msg').style.display='block';

            let total = 0;
            
            // æ ¹æ“šæƒæåˆ°çš„æ¨¡å‹åç¨±ï¼Œå‹•æ…‹çµ„è£ URL (ç§»é™¤ models/ å‰ç¶´ä»¥å…é‡è¤‡)
            const cleanModelName = modelName.replace("models/", "");
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${cleanModelName}:generateContent?key=${key}`;

            for(let i=0; i<currentQuizQuestions.length; i++) {
                const q = currentQuizQuestions[i];
                if(q.type==='essay') {
                    const res = await callGemini(url, q.question, q.answer, q.criteria_display, userAnswers[i]||"æœªä½œç­”");
                    aiResults[i] = res; total += res.score;
                } else {
                    if(userAnswers[i]==q.answer) total+=100;
                }
            }

            const final = Math.round(total/currentQuizQuestions.length);
            isReviewMode=true;
            let d = JSON.parse(localStorage.getItem('user_'+currentUser));
            d.history.push({score:final, modeText:document.getElementById('quiz-title').innerText, date:new Date().toLocaleString()});
            localStorage.setItem('user_'+currentUser, JSON.stringify(d));

            document.getElementById('quiz-status').innerText=`å¾—åˆ†ï¼š${final}`;
            document.getElementById('ai-loading-msg').style.display='none';
            document.getElementById('finish-area').style.display='block';
            document.getElementById('exit-btn').style.display='none';
            render();
            alert("é–±å·å®Œæˆï¼");
        }

        async function callGemini(url, q, ans, crit, user) {
            const prompt = `é¡Œç›®:${q}\næ¨™æº–:${ans}\nè©•åˆ†:${crit}\nè€ƒç”Ÿ:${user}\nè«‹è©•åˆ†(0-100)ä¸¦çµ¦è©•èªã€‚è¼¸å‡ºJSON:{"score":æ•¸å­—,"feedback":"å…§å®¹"}`;
            try {
                const r = await fetch(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                if(!r.ok) { const e = await r.json(); throw new Error(e.error?.message||"API Error"); }
                const d = await r.json();
                let t = d.candidates[0].content.parts[0].text.replace(/```json|```/g,'').trim();
                return JSON.parse(t);
            } catch(e) {
                console.error(e);
                return {score:0, feedback:`âš ï¸ éŒ¯èª¤ï¼š${e.message}`};
            }
        }
    </script>
</body>
</html>