<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è·å®‰è¡›ç³»çµ± - V38 è‡ªæˆ‘è©•é‡ç‰ˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { --primary-color: #003366; --accent-color: #ff9800; }
        body { background-color: #f4f7f9; font-family: "Microsoft JhengHei", sans-serif; -webkit-tap-highlight-color: transparent; }
        .quiz-header { background: var(--primary-color); color: white; padding: 20px 0; border-bottom: 5px solid var(--accent-color); }
        .card { border-radius: 15px; border: none; box-shadow: 0 8px 20px rgba(0,0,0,0.15); margin-bottom: 20px; }
        
        /* éº¥å…‹é¢¨ (ç€è¦½å™¨å…§å»ºåŠŸèƒ½ï¼Œä¸éœ€ API) */
        .mic-btn { font-size: 1.8rem; border: none; background: #f8d7da; color: #dc3545; border-radius: 50%; width: 60px; height: 60px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: 0.3s; cursor: pointer; }
        .mic-btn.recording { background: #dc3545 !important; color: white !important; animation: pulse 1.5s infinite; transform: scale(1.1); }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(220, 53, 69, 0); } 100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); } }

        .essay-input { width: 100%; min-height: 150px; border-radius: 10px; border: 2px solid #ddd; padding: 12px; font-size: 1.1rem; }
        .ref-answer-box { background: #f1f8e9; border-left: 5px solid #558b2f; padding: 15px; margin-top: 15px; border-radius: 5px; white-space: pre-wrap; font-size: 1.05rem; line-height: 1.6;}
        
        .option-btn { text-align: left; margin-bottom: 12px; width: 100%; border-radius: 12px; border: 1px solid #ddd; padding: 15px; background: white; font-size: 1.1rem; cursor: pointer; display: block; transition: 0.2s; }
        .option-btn.selected { background: #003366; color: white; }
        .correct { background: #2e7d32 !important; color: white !important; }
        .wrong { background: #c62828 !important; color: white !important; }
    </style>
</head>
<body>

    <div class="quiz-header text-center">
        <h1 class="fw-bold">è·å®‰è¡›ç·´ç¿’ç³»çµ± <small class="fs-6 text-warning">V38</small></h1>
        <div id="user-display" class="fw-bold">ç³»çµ±è¼‰å…¥ä¸­...</div>
    </div>

    <div id="auth-container" class="container mt-4">
        <div class="card p-4 mx-auto shadow-lg" style="max-width: 400px;">
            <h3 class="text-center mb-4 text-primary">å­¸å“¡ç™»å…¥</h3>
            <input type="text" id="username" class="form-control mb-3" placeholder="è«‹è¼¸å…¥å¸³è™Ÿ">
            <input type="password" id="password" class="form-control mb-4" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
            <button onclick="handleAuth()" class="btn btn-primary w-100 btn-lg shadow">é€²å…¥ç³»çµ±</button>
        </div>
    </div>

    <div id="setup-container" class="container mt-4" style="display:none;">
        <div class="row">
            <div class="col-md-7">
                <div class="card p-4 shadow">
                    <h4 class="fw-bold text-primary mb-4 border-bottom pb-2">æ¸¬é©—åƒæ•¸è¨­å®š</h4>

                    <div class="mb-4">
                        <label class="fw-bold fs-5">ç¬¬ä¸€æ­¥ï¼šé¸æ“‡æ¸¬é©—æ¨¡å¼</label>
                        <select id="type-select" class="form-select form-select-lg" onchange="toggleRangeUI()">
                            <option value="essay">è¡“ç§‘æ¸¬è©¦ (ä½œç­”èˆ‡è‡ªæˆ‘æ ¸å°)</option>
                            <option value="single">å­¸ç§‘æ¸¬è©¦ (å–®é¸é¡Œ)</option>
                            <option value="multiple">å­¸ç§‘æ¸¬è©¦ (è¤‡é¸é¡Œ)</option>
                            <option value="full-80">å­¸ç§‘å…¨æ¸¬ (60å–®é¸ + 20è¤‡é¸)</option>
                        </select>
                    </div>

                    <div class="row mb-4">
                        <div class="col-4">
                            <label class="fw-bold">å¹´åº¦</label>
                            <select id="year-select" class="form-select"></select>
                        </div>
                        <div class="col-4">
                            <label class="fw-bold">æ¢¯æ¬¡</label>
                            <select id="batch-select" class="form-select"></select>
                        </div>
                        <div class="col-4">
                            <label class="fw-bold text-success">ç§‘ç›®</label>
                            <select id="subject-select" class="form-select border-success">
                                <option value="å®‰å…¨">å®‰å…¨</option>
                                <option value="è¡›ç”Ÿ">è¡›ç”Ÿ</option>
                                <option value="ä¸åˆ†">ä¸åˆ†ç§‘</option>
                            </select>
                        </div>
                    </div>

                    <div id="range-section" style="display:none;" class="mb-4">
                        <label class="fw-bold">é¡Œè™Ÿç¯„åœ</label>
                        <select id="range-select" class="form-select">
                            <option value="1-20">1-20 é¡Œ</option>
                            <option value="21-40">21-40 é¡Œ</option>
                            <option value="41-60">41-60 é¡Œ</option>
                        </select>
                    </div>

                    <button onclick="prepareQuiz()" class="btn btn-primary w-100 btn-lg shadow">é–‹å§‹æ¸¬é©—</button>
                </div>
            </div>
            <div class="col-md-5">
                <div class="card p-4 shadow">
                    <h4 class="fw-bold mb-4 border-bottom pb-2">æ­·å²æˆç¸¾</h4>
                    <div id="history-list"></div>
                    <button onclick="logout()" class="btn btn-link w-100 mt-3 text-danger">ç™»å‡ºç³»çµ±</button>
                </div>
            </div>
        </div>
    </div>

    <div id="quiz-container" class="container mt-3" style="display:none;">
        <div class="sticky-top bg-white p-3 mb-4 border-bottom d-flex justify-content-between align-items-center shadow-sm rounded">
            <button onclick="location.reload()" class="btn btn-outline-secondary btn-sm">é€€å‡º</button>
            <span id="quiz-title" class="fw-bold text-primary"></span>
            <div id="quiz-status" class="badge bg-dark fs-6">ä½œç­”ä¸­</div>
        </div>
        
        <div id="question-list"></div>
        
        <div class="text-center mt-5 mb-5">
            <button id="submit-btn" onclick="submitQuiz()" class="btn btn-success btn-lg px-5 shadow fw-bold">äº¤å· / é¡¯ç¤ºè§£ç­”</button>
        </div>
    </div>

    <script src="questions.js"></script>
    <script>
        let currentUser = null, currentQuizQuestions = [], userAnswers = {}, isReviewMode = false;
        
        // èªéŸ³è¾¨è­˜ (é€™æ˜¯ç€è¦½å™¨åŸç”Ÿ APIï¼Œä¸éœ€ä»»ä½• Key)
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = SpeechRecognition ? new SpeechRecognition() : null;
        let isRecording = false, currentMicIdx = null;

        if (recognition) {
            recognition.lang = 'zh-TW'; recognition.continuous = true; recognition.interimResults = true;
            recognition.onresult = (e) => {
                const area = document.getElementById(`ans-${currentMicIdx}`);
                for (let i = e.resultIndex; i < e.results.length; ++i) {
                    if (e.results[i].isFinal) {
                        area.value += e.results[i][0].transcript;
                        userAnswers[currentMicIdx] = area.value;
                    }
                }
            };
            recognition.onend = () => { if (isRecording) recognition.start(); };
        }

        function toggleMic(idx, btn) {
            if (!recognition) return alert("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¼¸å…¥åŠŸèƒ½");
            if (!isRecording) {
                isRecording = true; currentMicIdx = idx;
                btn.classList.add('recording'); btn.innerHTML = "â¹ï¸";
                recognition.start();
            } else {
                isRecording = false; btn.classList.remove('recording');
                btn.innerText = "ğŸ¤"; recognition.stop();
            }
        }

        window.onload = function() {
            const u = localStorage.getItem('active_session_user');
            if(u) { currentUser=u; showDashboard(); }
        };

        function handleAuth() {
            const u = document.getElementById('username').value.trim();
            if(!u) return alert("è«‹è¼¸å…¥å¸³è™Ÿ");
            currentUser=u; localStorage.setItem('active_session_user', u);
            showDashboard();
        }

        function showDashboard() {
            document.getElementById('auth-container').style.display='none';
            document.getElementById('setup-container').style.display='block';
            document.getElementById('user-display').innerText = `å­¸å“¡ï¼š${currentUser}`;
            if(typeof questionBank !== 'undefined') {
                const years = [...new Set(questionBank.map(q=>q.year))].sort((a,b)=>b-a);
                document.getElementById('year-select').innerHTML = years.map(y=>`<option value="${y}">${y} å¹´</option>`).join('');
                const batches = [...new Set(questionBank.map(q=>q.batch))].sort((a,b)=>a-b);
                document.getElementById('batch-select').innerHTML = batches.map(b=>`<option value="${b}">ç¬¬ ${b} æ¢¯æ¬¡</option>`).join('');
            }
        }

        function toggleRangeUI() {
            const m = document.getElementById('type-select').value;
            document.getElementById('range-section').style.display = (m==='single'||m==='multiple') ? 'block' : 'none';
        }

        function prepareQuiz() {
            const t = document.getElementById('type-select').value;
            const y = document.getElementById('year-select').value;
            const b = document.getElementById('batch-select').value;
            const sub = document.getElementById('subject-select').value;
            const r = document.getElementById('range-select').value;

            // ç¢ºä¿éæ¿¾æ™‚å®¹éŒ¯è™•ç† Excel çš„ "ç”²ç´šå®‰å…¨" æˆ– "å®‰å…¨"
            const matchSubject = (qSub) => sub === 'ä¸åˆ†' || !qSub || qSub.includes(sub);

            if (t === 'full-80') {
                const s = questionBank.filter(q => q.year==y && q.batch==b && matchSubject(q.subject) && q.mode==='å–®é¸').slice(0,60);
                const m = questionBank.filter(q => q.year==y && q.batch==b && matchSubject(q.subject) && q.mode==='è¤‡é¸').slice(0,20);
                currentQuizQuestions = [...s, ...m];
            } else {
                currentQuizQuestions = questionBank.filter(q => {
                    const basic = (q.year == y) && (q.batch == b) && matchSubject(q.subject);
                    if(t==='essay') return basic && q.type==='essay';
                    if(t==='single') return basic && (q.mode==='å–®é¸' || q.type==='choice');
                    if(t==='multiple') return basic && q.mode==='è¤‡é¸';
                    return false;
                });
                
                if(t==='single' || t==='multiple') {
                    if(r==='1-20') currentQuizQuestions = currentQuizQuestions.slice(0, 20);
                    else if(r==='21-40') currentQuizQuestions = currentQuizQuestions.slice(20, 40);
                    else if(r==='41-60') currentQuizQuestions = currentQuizQuestions.slice(40, 60);
                }
            }

            if(currentQuizQuestions.length===0) return alert("æŸ¥ç„¡æ­¤ã€Œç§‘ç›®/å¹´åº¦/æ¢¯æ¬¡/ç¯„åœã€çš„é¡Œç›®ï¼Œè«‹é‡æ–°é¸æ“‡ï¼");
            
            document.getElementById('setup-container').style.display='none';
            document.getElementById('quiz-container').style.display='block';
            
            let rangeText = (t==='single' || t==='multiple') ? ` (${r}é¡Œ)` : "";
            document.getElementById('quiz-title').innerText = `${sub} - ${document.getElementById('type-select').selectedOptions[0].text}${rangeText}`;
            
            userAnswers={}; isReviewMode=false;
            document.getElementById('submit-btn').style.display = 'inline-block';
            render();
        }

        function render() {
            const list = document.getElementById('question-list');
            list.innerHTML = '';
            currentQuizQuestions.forEach((q, i) => {
                const card = document.createElement('div');
                card.className = 'card p-4 shadow-sm';
                
                if(q.type === 'choice' || q.mode === 'å–®é¸' || q.mode === 'è¤‡é¸') {
                    // å­¸ç§‘ï¼šé¸æ“‡é¡Œ
                    let h = `<h5>ç¬¬${i+1}é¡Œï¼š${q.question}</h5>`;
                    if(q.options && q.options.length > 0) {
                        q.options.forEach((opt, oi) => {
                            let cls = 'option-btn';
                            if(userAnswers[i] == (oi+1)) cls += ' selected';
                            if(isReviewMode) {
                                if(oi+1 == q.answer) cls += ' correct';
                                else if(userAnswers[i] == (oi+1)) cls += ' wrong';
                            }
                            h += `<button class="${cls}" onclick="userAnswers[${i}]=${oi+1}; render();" ${isReviewMode?'disabled':''}>(${oi+1}) ${opt}</button>`;
                        });
                    }
                    card.innerHTML = h;
                } else {
                    // è¡“ç§‘ï¼šå•ç­”é¡Œ
                    card.innerHTML = `<h5>ç¬¬${i+1}é¡Œï¼š${q.question}</h5>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-2">
                                <b>æ‚¨çš„ä½œç­”ï¼š</b>
                                ${!isReviewMode ? `<button class="mic-btn" onclick="toggleMic(${i}, this)">ğŸ¤</button>` : ''}
                            </div>
                            <textarea id="ans-${i}" class="essay-input" ${isReviewMode?'disabled':''} oninput="userAnswers[${i}]=this.value" placeholder="è«‹è¼¸å…¥ç­”æ¡ˆæˆ–é»æ“Šéº¥å…‹é¢¨èªéŸ³è¼¸å…¥...">${userAnswers[i]||''}</textarea>
                        </div>
                        ${isReviewMode ? `<div class="ref-answer-box"><b>ğŸ“ åƒè€ƒè§£ç­”ï¼š</b>\n${q.answer}</div>` : ''}`;
                }
                list.appendChild(card);
            });
            updateTotalScore();
        }

        function updateTotalScore() {
            if(!isReviewMode) return;
            
            let earned = 0, possible = 0, hasChoice = false;
            
            currentQuizQuestions.forEach((q, i) => {
                // åƒ…è¨ˆç®—é¸æ“‡é¡Œçš„åˆ†æ•¸
                if (q.type === 'choice' || q.mode === 'å–®é¸' || q.mode === 'è¤‡é¸') {
                    hasChoice = true;
                    const weightMatch = q.question.match(/\((\d+)åˆ†\)/) || q.question.match(/ï¼ˆ(\d+)åˆ†ï¼‰/);
                    const weight = weightMatch ? parseInt(weightMatch[1]) : (q.weight || 2);
                    possible += weight;
                    if (userAnswers[i] == q.answer) earned += weight;
                }
            });

            if (hasChoice) {
                document.getElementById('quiz-status').innerText = `å­¸ç§‘å¾—åˆ†ï¼š${earned} / ${possible}`;
            } else {
                document.getElementById('quiz-status').innerText = `ä½œç­”çµæŸï¼Œè«‹æ ¸å°ä¸‹æ–¹è§£ç­”`;
                document.getElementById('quiz-status').classList.replace('bg-dark', 'bg-success');
            }
        }

        function submitQuiz() {
            if(!confirm("ç¢ºå®šè¦äº¤å·å—ï¼Ÿ")) return;
            
            isReviewMode = true;
            document.getElementById('submit-btn').style.display = 'none';
            render();
            window.scrollTo(0, 0); // å›åˆ°é ‚éƒ¨çœ‹åˆ†æ•¸æˆ–æ ¸å°
        }

        function logout() { localStorage.removeItem('active_session_user'); location.reload(); }
    </script>
</body>
</html>