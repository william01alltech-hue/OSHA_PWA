<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è·å®‰è¡›ç³»çµ± - V35 ç©©å®šåŠ æ¬Šç‰ˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root { --primary-color: #003366; --accent-color: #ff9800; }
        body { background-color: #f4f7f9; font-family: "Microsoft JhengHei", sans-serif; -webkit-tap-highlight-color: transparent; }
        .quiz-header { background: var(--primary-color); color: white; padding: 20px 0; border-bottom: 5px solid var(--accent-color); }
        .card { border-radius: 15px; border: none; box-shadow: 0 8px 20px rgba(0,0,0,0.15); margin-bottom: 20px; }
        
        /* éº¥å…‹é¢¨åˆ‡æ›èˆ‡å‹•ç•« */
        .mic-btn { font-size: 1.8rem; border: none; background: #f8d7da; color: #dc3545; border-radius: 50%; width: 60px; height: 60px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: 0.3s; cursor: pointer; }
        .mic-btn.recording { background: #dc3545 !important; color: white !important; animation: pulse 1.5s infinite; transform: scale(1.1); }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(220, 53, 69, 0); } 100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); } }

        .essay-input { width: 100%; min-height: 150px; border-radius: 10px; border: 2px solid #ddd; padding: 12px; font-size: 1.1rem; }
        .ai-feedback-box { background: #e3f2fd; border-left: 5px solid #2196f3; padding: 15px; margin-top: 15px; border-radius: 5px; }
        .ref-answer-box { background: #f1f8e9; border-left: 5px solid #558b2f; padding: 15px; margin-top: 10px; border-radius: 5px; white-space: pre-wrap; }
        
        .option-btn { text-align: left; margin-bottom: 12px; width: 100%; border-radius: 12px; border: 1px solid #ddd; padding: 15px; background: white; font-size: 1.1rem; cursor: pointer; display: block; transition: 0.2s; }
        .option-btn.selected { background: #003366; color: white; }
        .correct { background: #2e7d32 !important; color: white !important; }
        .wrong { background: #c62828 !important; color: white !important; }
        .retry-btn { margin-top: 10px; font-weight: bold; }
    </style>
</head>
<body>

    <div class="quiz-header text-center">
        <h1 class="fw-bold">è·å®‰è¡›ç·´ç¿’ç³»çµ± <small class="fs-6 text-warning">V35</small></h1>
        <div id="user-display" class="fw-bold">ç³»çµ±è¼‰å…¥ä¸­...</div>
    </div>

    <div id="auth-container" class="container mt-4">
        <div class="card p-4 mx-auto shadow-lg" style="max-width: 400px;">
            <h3 class="text-center mb-4 text-primary">å­¸å“¡ç™»å…¥</h3>
            <input type="text" id="username" class="form-control mb-3" placeholder="å¸³è™Ÿ">
            <input type="password" id="password" class="form-control mb-4" placeholder="å¯†ç¢¼">
            <button onclick="handleAuth()" class="btn btn-primary w-100 btn-lg shadow">é€²å…¥ç³»çµ±</button>
        </div>
    </div>

    <div id="setup-container" class="container mt-4" style="display:none;">
        <div class="card p-4 shadow">
            <h4 class="fw-bold text-primary mb-4 border-bottom pb-2">æ¸¬é©—åƒæ•¸è¨­å®š</h4>
            <div class="mb-4 bg-light p-3 rounded border">
                <label class="fw-bold text-primary mb-2">ğŸ¤– AI æ¨¡å‹è¨­å®š</label>
                <div class="input-group">
                    <button class="btn btn-primary" onclick="scanAvailableModels()">ğŸ” æƒææ¨¡å‹</button>
                    <select id="model-select" class="form-select"><option value="" disabled selected>è«‹å…ˆæƒæ...</option></select>
                </div>
            </div>
            <div class="mb-4">
                <label class="fw-bold">æ¸¬é©—æ¨¡å¼</label>
                <select id="type-select" class="form-select form-select-lg" onchange="toggleRangeUI()">
                    <option value="essay">è¡“ç§‘æ¸¬è©¦ (AI åŠ æ¬Šè©•åˆ†)</option>
                    <option value="single">å­¸ç§‘æ¸¬è©¦ (å–®é¸é¡Œ)</option>
                    <option value="multiple">å­¸ç§‘æ¸¬è©¦ (è¤‡é¸é¡Œ)</option>
                </select>
            </div>
            <div class="row mb-4">
                <div class="col"><label class="fw-bold">å¹´åº¦</label><select id="year-select" class="form-select"></select></div>
                <div class="col"><label class="fw-bold">æ¢¯æ¬¡</label><select id="batch-select" class="form-select"></select></div>
            </div>
            <button onclick="prepareQuiz()" class="btn btn-primary w-100 btn-lg shadow">é–‹å§‹æ¸¬é©—</button>
        </div>
    </div>

    <div id="quiz-container" class="container mt-3" style="display:none;">
        <div class="sticky-top bg-white p-3 mb-4 border-bottom d-flex justify-content-between align-items-center shadow-sm rounded">
            <button onclick="location.reload()" class="btn btn-outline-secondary btn-sm">é€€å‡º</button>
            <span id="quiz-title" class="fw-bold text-primary"></span>
            <div id="quiz-status" class="badge bg-dark fs-6">ä½œç­”ä¸­</div>
        </div>
        <div id="question-list"></div>
        <div class="text-center mt-5 mb-5">
            <button id="ai-submit-btn" onclick="submitQuiz()" class="btn btn-success btn-lg px-5 shadow fw-bold">äº¤å·ä¸¦è«‹ AI è©•åˆ†</button>
            <div id="ai-loading-msg" class="text-primary mt-3 fw-bold" style="display:none;">
                <span class="spinner-border spinner-border-sm me-2"></span>AI é–±å·ä¸­ï¼Œè«‹è€å¿ƒå€™å¾… (æ¯é¡Œ 3 ç§’é–“éš”é¿å…è¶…é¡)...
            </div>
        </div>
    </div>

    <script src="questions.js"></script>
    <script>
        const SYSTEM_API_KEY = "AIzaSyBVNhf-jPE1G-GD8q8FtbjnlK-_5StKL-I"; 

        let currentUser = null, currentQuizQuestions = [], userAnswers = {}, aiResults = {}, isReviewMode = false;
        
        // èªéŸ³è¾¨è­˜
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = SpeechRecognition ? new SpeechRecognition() : null;
        let isRecording = false, currentMicIdx = null;

        if (recognition) {
            recognition.lang = 'zh-TW'; recognition.continuous = true; recognition.interimResults = true;
            recognition.onresult = (e) => {
                const area = document.getElementById(`ans-${currentMicIdx}`);
                for (let i = e.resultIndex; i < e.results.length; ++i) {
                    if (e.results[i].isFinal) {
                        area.value += e.results[i][0].transcript;
                        userAnswers[currentMicIdx] = area.value;
                    }
                }
            };
            recognition.onend = () => { if (isRecording) recognition.start(); };
        }

        function toggleMic(idx, btn) {
            if (!recognition) return alert("ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³");
            if (!isRecording) {
                isRecording = true; currentMicIdx = idx;
                btn.classList.add('recording'); btn.innerHTML = "â¹ï¸";
                recognition.start();
            } else {
                isRecording = false; btn.classList.remove('recording');
                btn.innerText = "ğŸ¤"; recognition.stop();
            }
        }

        window.onload = function() {
            const u = localStorage.getItem('active_session_user');
            if(u) { currentUser=u; showDashboard(); }
        };

        function handleAuth() {
            const u = document.getElementById('username').value.trim();
            if(!u) return alert("è«‹è¼¸å…¥å¸³è™Ÿ");
            currentUser=u; localStorage.setItem('active_session_user', u);
            showDashboard();
        }

        function showDashboard() {
            document.getElementById('auth-container').style.display='none';
            document.getElementById('setup-container').style.display='block';
            document.getElementById('user-display').innerText = `å­¸å“¡ï¼š${currentUser}`;
            if(typeof questionBank !== 'undefined') {
                const years = [...new Set(questionBank.map(q=>q.year))].sort((a,b)=>b-a);
                document.getElementById('year-select').innerHTML = years.map(y=>`<option value="${y}">${y}</option>`).join('');
                const batches = [...new Set(questionBank.map(q=>q.batch))].sort((a,b)=>a-b);
                document.getElementById('batch-select').innerHTML = batches.map(b=>`<option value="${b}">${b}</option>`).join('');
            }
        }

        async function scanAvailableModels() {
            const key = SYSTEM_API_KEY.trim();
            const select = document.getElementById('model-select');
            try {
                const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${key}`);
                const data = await resp.json();
                const valid = data.models.filter(m => m.supportedGenerationMethods.includes("generateContent"));
                select.innerHTML = valid.map(m => `<option value="${m.name}">${m.displayName}</option>`).join('');
                alert("æƒæå®Œæˆ");
            } catch(e) { alert("æƒæå¤±æ•—"); }
        }

        function prepareQuiz() {
            const t = document.getElementById('type-select').value;
            const y = document.getElementById('year-select').value;
            const b = document.getElementById('batch-select').value;
            currentQuizQuestions = questionBank.filter(q=>q.year==y && q.batch==b && (t==='essay'?q.type==='essay':(q.mode===(t==='single'?'å–®é¸':'è¤‡é¸'))));
            if(currentQuizQuestions.length===0) return alert("ç„¡è³‡æ–™");
            document.getElementById('setup-container').style.display='none';
            document.getElementById('quiz-container').style.display='block';
            userAnswers={}; aiResults={}; isReviewMode=false;
            render();
        }

        function render() {
            const list = document.getElementById('question-list');
            list.innerHTML = '';
            currentQuizQuestions.forEach((q, i) => {
                const card = document.createElement('div');
                card.className = 'card p-4 shadow-sm';
                
                if(q.type === 'choice' || q.mode) {
                    let h = `<h5>ç¬¬${i+1}é¡Œï¼š${q.question}</h5>`;
                    q.options.forEach((opt, oi) => {
                        let cls = 'option-btn';
                        if(userAnswers[i] == (oi+1)) cls += ' selected';
                        if(isReviewMode) {
                            if(oi+1 == q.answer) cls += ' correct';
                            else if(userAnswers[i] == (oi+1)) cls += ' wrong';
                        }
                        h += `<button class="${cls}" onclick="userAnswers[${i}]=${oi+1}; render();" ${isReviewMode?'disabled':''}>(${oi+1}) ${opt}</button>`;
                    });
                    card.innerHTML = h;
                } else {
                    const ai = aiResults[i];
                    const weightMatch = q.question.match(/\((\d+)åˆ†\)/) || q.question.match(/ï¼ˆ(\d+)åˆ†ï¼‰/);
                    const weight = weightMatch ? weightMatch[1] : "10";
                    
                    let scoreDisplay = "--";
                    if(ai && !ai.isError) scoreDisplay = ai.actual_score;
                    
                    card.innerHTML = `<h5>ç¬¬${i+1}é¡Œï¼š${q.question}</h5>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-2">
                                <b>ä½œç­”å€ ${isReviewMode?`<span class="${ai?.isError?'text-warning':'text-danger'}">(${scoreDisplay} / ${weight}åˆ†)</span>`:''}</b>
                                ${!isReviewMode ? `<button class="mic-btn" onclick="toggleMic(${i}, this)">ğŸ¤</button>` : ''}
                            </div>
                            <textarea id="ans-${i}" class="essay-input" ${isReviewMode?'disabled':''} oninput="userAnswers[${i}]=this.value">${userAnswers[i]||''}</textarea>
                        </div>
                        ${isReviewMode ? `
                            <div class="ai-feedback-box">
                                <b>ğŸ¤– AI è¬›è©•ï¼š</b>
                                <div>${marked.parse(ai?ai.feedback:'å°šæœªè©•åˆ†')}</div>
                                ${ai?.isError ? `<button class="btn btn-sm btn-warning retry-btn" onclick="retrySingle(${i})">ğŸ”„ é‡æ–°è«‹ AI è©•åˆ† (ä¸è¨ˆ 0 åˆ†)</button>` : ''}
                            </div>
                            <div class="ref-answer-box"><b>åƒè€ƒè§£ç­”ï¼š</b>\n${q.answer}</div>` : ''}`;
                }
                list.appendChild(card);
            });
            updateTotalScore();
        }

        function updateTotalScore() {
            if(!isReviewMode) return;
            let earned = 0, possible = 0;
            currentQuizQuestions.forEach((q, i) => {
                const weightMatch = q.question.match(/\((\d+)åˆ†\)/) || q.question.match(/ï¼ˆ(\d+)åˆ†ï¼‰/);
                const weight = weightMatch ? parseInt(weightMatch[1]) : 10;
                possible += weight;
                if(aiResults[i] && !aiResults[i].isError) earned += aiResults[i].actual_score;
                else if(q.type === 'choice' && userAnswers[i] == q.answer) earned += weight;
            });
            document.getElementById('quiz-status').innerText = `ç›®å‰å¾—åˆ†ï¼š${earned} / ${possible}`;
        }

        async function submitQuiz() {
            const hasEssay = currentQuizQuestions.some(q => q.type==='essay');
            const model = document.getElementById('model-select').value;
            if(hasEssay && !model) return alert("è«‹å…ˆæƒææ¨¡å‹");
            if(!confirm("ç¢ºå®šäº¤å·ï¼Ÿ")) return;

            document.getElementById('ai-submit-btn').style.display='none';
            document.getElementById('ai-loading-msg').style.display='block';

            for(let i=0; i<currentQuizQuestions.length; i++) {
                const q = currentQuizQuestions[i];
                if(q.type==='essay') {
                    if (i > 0) await new Promise(r => setTimeout(r, 3000));
                    aiResults[i] = await callAIStrict(q, userAnswers[i]||"æœªä½œç­”");
                }
            }

            isReviewMode=true;
            document.getElementById('ai-loading-msg').style.display='none';
            render();
        }

        async function retrySingle(idx) {
            const q = currentQuizQuestions[idx];
            const feedbackBox = document.querySelectorAll('.ai-feedback-box')[idx];
            feedbackBox.innerHTML = "â³ æ­£åœ¨é‡æ–°å‘¼å« AIï¼Œè«‹ç¨å€™...";
            const res = await callAIStrict(q, userAnswers[idx]||"æœªä½œç­”");
            aiResults[idx] = res;
            render();
        }

        async function callAIStrict(q, user) {
            const key = SYSTEM_API_KEY.trim();
            const model = document.getElementById('model-select').value;
            const weightMatch = q.question.match(/\((\d+)åˆ†\)/) || q.question.match(/ï¼ˆ(\d+)åˆ†ï¼‰/);
            const weight = weightMatch ? parseInt(weightMatch[1]) : 10;
            
            const prompt = `ä½ æ˜¯ä¸€ä½æ¥µåº¦åš´æ ¼çš„é–±å·å®˜ã€‚é¡Œç›®:"${q}"(æ»¿åˆ†${weight})ã€‚åƒè€ƒç­”æ¡ˆ:"${q.answer}"ã€‚è€ƒç”Ÿå›ç­”:"${user}"ã€‚
            è¦å‰‡: 1.è‹¥å­¸å“¡å›ç­”ç‚ºäº‚ç¢¼ã€ç„¡æ„ç¾©æ–‡å­—(å¦‚å“ˆå“ˆ)ã€æˆ–å®Œå…¨ç„¡é—œï¼Œå¿…é ˆçµ¦ 0 åˆ†ã€‚2.æ ¹æ“šæ­£ç¢ºåº¦çµ¦0~${weight}åˆ†ã€‚3.è©•èªç›´æ¥æŒ‡å‡ºç¼ºé»ï¼Œä¸å¯è™›å‡é¼“å‹µã€‚
            è¼¸å‡ºç´”JSON: {"actual_score":æ•¸å­—, "feedback":"è©•èª"}`;
            
            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/${model.replace("models/","")}:generateContent?key=${key}`;
                const r = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({contents:[{parts:[{text:prompt}]}]}) });
                const d = await r.json();
                if(!r.ok) throw new Error(d.error?.message);
                let t = d.candidates[0].content.parts[0].text.replace(/```json|```/g,'').trim();
                const res = JSON.parse(t);
                return { actual_score: res.actual_score, feedback: res.feedback, isError: false };
            } catch(e) {
                return { actual_score: 0, feedback: "âš ï¸ **API ç¹å¿™ (é…é¡è¶…å‡º)**\n\nç³»çµ±å°šæœªè©•åˆ†ï¼Œè«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•é‡è©¦ã€‚æœ¬æ¬¡éŒ¯èª¤ä¸è¨ˆå…¥ç¸½åˆ†ã€‚", isError: true };
            }
        }
    </script>
</body>
</html>